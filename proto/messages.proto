syntax = "proto3";

package carabiner.messages;

import "google/protobuf/struct.proto";

// Basic transport messages for Rust <-> Python worker communication.
enum MessageKind {
  MESSAGE_KIND_UNSPECIFIED = 0;
  MESSAGE_KIND_ACTION_DISPATCH = 1;
  MESSAGE_KIND_ACTION_RESULT = 2;
  MESSAGE_KIND_ACK = 3;
  MESSAGE_KIND_HEARTBEAT = 4;
  MESSAGE_KIND_WORKER_HELLO = 5;
}

message Envelope {
  uint64 delivery_id = 1;
  // Optional identifier that allows grouping by logical partition.
  uint32 partition_id = 2;
  MessageKind kind = 3;
  bytes payload = 4;
}

message ActionDispatch {
  string action_id = 1;
  string instance_id = 2;
  uint32 sequence = 3;
  WorkflowNodeDispatch dispatch = 4;
}

message ActionResult {
  string action_id = 1;
  bool success = 2;
  WorkflowArguments payload = 3;
  uint64 worker_start_ns = 4;
  uint64 worker_end_ns = 5;
}

message Ack {
  uint64 acked_delivery_id = 1;
}

message WorkerHello {
  uint64 worker_id = 1;
}

message WorkflowDagNode {
  string id = 1;
  string action = 2;
  map<string, string> kwargs = 3;
  repeated string depends_on = 4;
  repeated string wait_for_sync = 5;
  repeated string produces = 6;
  string module = 7;
  string guard = 8;
  repeated WorkflowExceptionEdge exception_edges = 9;
}

message WorkflowDagDefinition {
  bool concurrent = 1;
  repeated WorkflowDagNode nodes = 2;
  string return_variable = 3;
}

message WorkflowExceptionEdge {
  string source_node_id = 1;
  string exception_type = 2;
  string exception_module = 3;
}

message WorkflowRegistration {
  string workflow_name = 1;
  WorkflowDagDefinition dag = 2;
  string dag_hash = 3;
}

message WorkflowNodeContext {
  string variable = 1;
  WorkflowArguments payload = 2;
  string workflow_node_id = 3;
}

// Workflow Argument Types
message WorkflowArgumentValue {
  oneof kind {
    PrimitiveWorkflowArgument primitive = 1;
    BaseModelWorkflowArgument basemodel = 2;
    WorkflowErrorValue exception = 3;
    WorkflowListArgument list_value = 4;
    WorkflowTupleArgument tuple_value = 5;
    WorkflowDictArgument dict_value = 6;
  }
}

message WorkflowArgument {
  string key = 1;
  WorkflowArgumentValue value = 2;
}

message WorkflowArguments {
  repeated WorkflowArgument arguments = 1;
}

message PrimitiveWorkflowArgument {
  oneof kind {
    string string_value = 1;
    double double_value = 2;
    sint64 int_value = 3;
    bool bool_value = 4;
    google.protobuf.NullValue null_value = 5;
  }
}

message BaseModelWorkflowArgument {
  string module = 1;
  string name = 2;
  google.protobuf.Struct data = 3;
}

message WorkflowErrorValue {
  string type = 1;
  string module = 2;
  string message = 3;
  string traceback = 4;
}

message WorkflowListArgument {
  repeated WorkflowArgumentValue items = 1;
}

message WorkflowTupleArgument {
  repeated WorkflowArgumentValue items = 1;
}

message WorkflowDictArgument {
  repeated WorkflowArgument entries = 1;
}

message WorkflowNodeDispatch {
  WorkflowDagNode node = 1;
  WorkflowArguments workflow_input = 2;
  repeated WorkflowNodeContext context = 3;
}

message RegisterWorkflowRequest {
  reserved 1;
  WorkflowRegistration registration = 2;
}

message RegisterWorkflowResponse {
  string workflow_version_id = 1;
  string workflow_instance_id = 2;
}

message WaitForInstanceRequest {
  string instance_id = 1;
  double poll_interval_secs = 2;
}

message WaitForInstanceResponse {
  bytes payload = 1;
}

service WorkflowService {
  rpc RegisterWorkflow(RegisterWorkflowRequest) returns (RegisterWorkflowResponse);
  rpc WaitForInstance(WaitForInstanceRequest) returns (WaitForInstanceResponse);
}

service WorkerBridge {
  rpc Attach(stream Envelope) returns (stream Envelope);
}
