{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}{{ title }}{% endblock title %}

{% block content %}
<section class="space-y-2">
    <p class="text-xs uppercase tracking-[0.3em] text-zinc-500">Overview</p>
    <h1 class="text-3xl font-semibold tracking-tight text-zinc-900 dark:text-white">Workers</h1>
    <p class="text-sm text-zinc-500 dark:text-zinc-500">Throughput stats for active worker pools.</p>
</section>

<section class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <form method="GET" action="/workers" class="flex w-full max-w-xl items-center gap-3 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white/50 dark:bg-zinc-900/20 px-4 py-2.5 backdrop-blur-sm focus-within:border-zinc-400 dark:focus-within:border-zinc-600 transition-colors">
        <label class="text-xs uppercase tracking-[0.2em] text-zinc-500">Window</label>
        <input
            type="number"
            name="minutes"
            min="1"
            value="{{ window_minutes }}"
            class="w-20 bg-transparent text-sm font-medium text-zinc-900 dark:text-white placeholder:text-zinc-500 focus:outline-none tabular-nums"
        />
        <span class="text-xs text-zinc-500">minutes</span>
        <button type="submit" class="ml-auto rounded-lg border border-zinc-300 dark:border-zinc-700 bg-zinc-100 dark:bg-zinc-800 px-3 py-1 text-xs font-medium text-zinc-700 dark:text-zinc-300 transition hover:bg-zinc-200 dark:hover:bg-zinc-700">Apply</button>
    </form>
    <div class="text-xs font-medium text-zinc-500 dark:text-zinc-500">
        Showing pools updated in the last {{ window_minutes }} minute{% if window_minutes != 1 %}s{% endif %}
    </div>
</section>

<section class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
    <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-5">
        <p class="text-xs uppercase tracking-[0.2em] text-zinc-500">Active Workers</p>
        <p class="mt-2 text-3xl font-semibold text-zinc-900 dark:text-white tabular-nums">{{ active_worker_count }}</p>
    </div>
    <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-5">
        <p class="text-xs uppercase tracking-[0.2em] text-zinc-500">Actions / sec</p>
        <p class="mt-2 text-3xl font-semibold text-zinc-900 dark:text-white tabular-nums">{{ actions_per_sec }}</p>
    </div>
    <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-5">
        <p class="text-xs uppercase tracking-[0.2em] text-zinc-500">Median Duration</p>
        <p class="mt-2 text-3xl font-semibold text-zinc-900 dark:text-white tabular-nums">{{ median_instance_duration }}</p>
    </div>
    <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-5">
        <p class="text-xs uppercase tracking-[0.2em] text-zinc-500">Active Instances</p>
        <p class="mt-2 text-3xl font-semibold text-zinc-900 dark:text-white tabular-nums">{{ active_instance_count }}</p>
    </div>
    <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-5">
        <p class="text-xs uppercase tracking-[0.2em] text-zinc-500">In-Flight Actions</p>
        <p class="mt-2 text-3xl font-semibold text-zinc-900 dark:text-white tabular-nums">{{ total_in_flight }}</p>
    </div>
    <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-5">
        <p class="text-xs uppercase tracking-[0.2em] text-zinc-500">Queue Depth</p>
        <p class="mt-2 text-3xl font-semibold text-zinc-900 dark:text-white tabular-nums">{{ total_queue_depth }}</p>
    </div>
</section>

{% if has_time_series %}
<section class="rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-5">
    <p class="text-xs uppercase tracking-[0.2em] text-zinc-500 mb-4">Actions / sec (2h)</p>
    <div id="ts-chart" style="width:100%;height:200px;"></div>
</section>

<section class="rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-5">
    <p class="text-xs uppercase tracking-[0.2em] text-zinc-500 mb-4">Active Instances (2h)</p>
    <div id="inst-chart" style="width:100%;height:200px;"></div>
</section>

<script>
(function() {
    var data = {{ time_series_json | safe }};
    if (!data || data.length === 0) return;

    var ns = 'http://www.w3.org/2000/svg';

    // Shared time range
    var tMin = data[0].t;
    var tMax = data[data.length - 1].t;
    var tRange = Math.max(tMax - tMin, 1);

    // ---- Helper: render a single-series chart ----
    function renderSingleChart(containerId, values, color) {
        var container = document.getElementById(containerId);
        if (!container) return;
        var W = container.clientWidth;
        var H = 200;
        var PAD_L = 50, PAD_R = 16, PAD_T = 12, PAD_B = 28;
        var plotW = W - PAD_L - PAD_R;
        var plotH = H - PAD_T - PAD_B;

        var maxV = 0;
        for (var i = 0; i < values.length; i++) {
            if (values[i] > maxV) maxV = values[i];
        }
        if (maxV === 0) maxV = 1;
        maxV *= 1.1;

        function x(t) { return PAD_L + ((t - tMin) / tRange) * plotW; }
        function y(v) { return PAD_T + plotH - (v / maxV) * plotH; }

        var svg = document.createElementNS(ns, 'svg');
        svg.setAttribute('width', W);
        svg.setAttribute('height', H);
        svg.setAttribute('viewBox', '0 0 ' + W + ' ' + H);
        svg.style.display = 'block';

        // Grid + Y labels
        for (var g = 0; g <= 4; g++) {
            var gy = PAD_T + (plotH / 4) * g;
            var line = document.createElementNS(ns, 'line');
            line.setAttribute('x1', PAD_L); line.setAttribute('x2', W - PAD_R);
            line.setAttribute('y1', gy); line.setAttribute('y2', gy);
            line.setAttribute('stroke', 'currentColor'); line.setAttribute('stroke-opacity', '0.1');
            svg.appendChild(line);
            var val = maxV - (maxV / 4) * g;
            var label = document.createElementNS(ns, 'text');
            label.setAttribute('x', PAD_L - 6); label.setAttribute('y', gy + 4);
            label.setAttribute('text-anchor', 'end');
            label.setAttribute('fill', 'currentColor'); label.setAttribute('fill-opacity', '0.5');
            label.setAttribute('font-size', '10');
            label.textContent = val < 10 ? val.toFixed(1) : Math.round(val).toString();
            svg.appendChild(label);
        }
        // X labels
        var labelCount = Math.min(6, data.length);
        for (var li = 0; li < labelCount; li++) {
            var idx = Math.floor((li / (labelCount - 1 || 1)) * (data.length - 1));
            var d = new Date(data[idx].t * 1000);
            var xl = x(data[idx].t);
            var xlabel = document.createElementNS(ns, 'text');
            xlabel.setAttribute('x', xl); xlabel.setAttribute('y', H - 4);
            xlabel.setAttribute('text-anchor', 'middle');
            xlabel.setAttribute('fill', 'currentColor'); xlabel.setAttribute('fill-opacity', '0.5');
            xlabel.setAttribute('font-size', '10');
            xlabel.textContent = ('0' + d.getHours()).slice(-2) + ':' + ('0' + d.getMinutes()).slice(-2);
            svg.appendChild(xlabel);
        }
        // Area + line
        var pts = [];
        for (var j = 0; j < data.length; j++) {
            pts.push(x(data[j].t).toFixed(1) + ',' + y(values[j]).toFixed(1));
        }
        var polygon = document.createElementNS(ns, 'polygon');
        polygon.setAttribute('points', pts.join(' ') + ' ' + x(tMax).toFixed(1) + ',' + (PAD_T + plotH) + ' ' + x(tMin).toFixed(1) + ',' + (PAD_T + plotH));
        polygon.setAttribute('fill', color); polygon.setAttribute('fill-opacity', '0.12');
        svg.appendChild(polygon);
        var polyline = document.createElementNS(ns, 'polyline');
        polyline.setAttribute('points', pts.join(' '));
        polyline.setAttribute('fill', 'none'); polyline.setAttribute('stroke', color); polyline.setAttribute('stroke-width', '1.5');
        svg.appendChild(polyline);
        container.appendChild(svg);
    }

    // Actions/sec chart
    renderSingleChart('ts-chart', data.map(function(d) { return d.aps; }), '#6366f1');

    // Active instances chart
    renderSingleChart('inst-chart', data.map(function(d) { return d.ai; }), '#10b981');
})();
</script>
{% endif %}

{% if action_rows | length == 0 %}
    <div class="rounded-xl border border-dashed border-zinc-300 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/20 p-8 text-center text-zinc-500 dark:text-zinc-500">
        No active workers reported in the selected window.
    </div>
{% else %}
    <div class="space-y-2">
        <p class="text-xs uppercase tracking-[0.2em] text-zinc-500">Actions</p>
    </div>
    <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead>
                    <tr class="border-b border-zinc-200 dark:border-zinc-800">
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Pool</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Workers</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Actions/sec</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Throughput/min</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Total Completed</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Median Dequeue</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Median Execution</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Last Action</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Updated</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in action_rows %}
                        <tr class="border-b border-zinc-100 dark:border-zinc-800/50 hover:bg-zinc-50 dark:hover:bg-zinc-900/50 transition-colors">
                            <td class="px-4 py-3 font-mono text-xs text-zinc-600 dark:text-zinc-400">{{ row.pool_id }}</td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 tabular-nums">{{ row.active_workers }}</td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 tabular-nums">{{ row.actions_per_sec }}</td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 tabular-nums">{{ row.throughput_per_min }}</td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 tabular-nums">{{ row.total_completed }}</td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 font-mono text-xs tabular-nums">
                                {% if row.median_dequeue_ms %}
                                    {{ row.median_dequeue_ms }}ms
                                {% else %}
                                    <span class="text-zinc-400">&mdash;</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 font-mono text-xs tabular-nums">
                                {% if row.median_handling_ms %}
                                    {{ row.median_handling_ms }}ms
                                {% else %}
                                    <span class="text-zinc-400">&mdash;</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 text-sm">
                                {% if row.last_action_at %}
                                    {{ macros::datetime(timestamp=row.last_action_at) }}
                                {% else %}
                                    <span class="text-zinc-400">(none)</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 text-sm">{{ macros::datetime(timestamp=row.updated_at) }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="space-y-2">
        <p class="text-xs uppercase tracking-[0.2em] text-zinc-500">Instances</p>
    </div>
    <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead>
                    <tr class="border-b border-zinc-200 dark:border-zinc-800">
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Pool</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Active Instances</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Instances/sec</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Instances/min</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Total Completed</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Median Duration</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Median Dequeue</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider font-medium text-zinc-500">Updated</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in instance_rows %}
                        <tr class="border-b border-zinc-100 dark:border-zinc-800/50 hover:bg-zinc-50 dark:hover:bg-zinc-900/50 transition-colors">
                            <td class="px-4 py-3 font-mono text-xs text-zinc-600 dark:text-zinc-400">{{ row.pool_id }}</td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 tabular-nums">{{ row.active_instances }}</td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 tabular-nums">{{ row.instances_per_sec }}</td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 tabular-nums">{{ row.instances_per_min }}</td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 tabular-nums">{{ row.total_completed }}</td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 font-mono text-xs tabular-nums">{{ row.median_duration }}</td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 font-mono text-xs tabular-nums">
                                {% if row.median_dequeue_ms %}
                                    {{ row.median_dequeue_ms }}ms
                                {% else %}
                                    <span class="text-zinc-400">&mdash;</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 text-sm">{{ macros::datetime(timestamp=row.updated_at) }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endif %}
{% endblock content %}
