<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rappel DAG Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #e4e4e7;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(to right, #18181b, #27272a);
            border-bottom: 1px solid #3f3f46;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }

        .header .badge {
            background: #3b82f6;
            color: white;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr 1.5fr;
            gap: 1px;
            background: #27272a;
            height: calc(100vh - 57px);
        }

        .panel {
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 16px;
            background: #18181b;
            border-bottom: 1px solid #27272a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-header .icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-header h2 {
            font-size: 14px;
            font-weight: 600;
            color: #a1a1aa;
        }

        .panel-content {
            flex: 1;
            overflow: auto;
            padding: 16px;
        }

        pre {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #d4d4d8;
        }

        .dag-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .dag-svg {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .dag-nodes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .dag-node {
            position: absolute;
            background: #18181b;
            border: 2px solid #3f3f46;
            border-radius: 12px;
            padding: 10px 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 140px;
            max-width: 200px;
        }

        .dag-node:hover {
            border-color: #6366f1;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
        }

        .dag-node.selected {
            border-color: #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        .dag-node .node-id {
            font-family: 'SF Mono', monospace;
            font-size: 10px;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .dag-node .node-label {
            font-size: 12px;
            font-weight: 500;
            color: #e4e4e7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dag-node .node-type {
            font-size: 10px;
            color: #a1a1aa;
            margin-top: 4px;
        }

        /* Node type colors */
        .dag-node[data-type="input"] {
            border-color: #22c55e;
            background: linear-gradient(135deg, #14532d 0%, #18181b 100%);
        }

        .dag-node[data-type="output"] {
            border-color: #f97316;
            background: linear-gradient(135deg, #7c2d12 0%, #18181b 100%);
        }

        .dag-node[data-type="action_call"] {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #1e3a5f 0%, #18181b 100%);
        }

        .dag-node[data-type="assignment"] {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #4c1d95 0%, #18181b 100%);
        }

        .dag-node[data-type="for_loop"] {
            border-color: #06b6d4;
            background: linear-gradient(135deg, #164e63 0%, #18181b 100%);
        }

        .dag-node[data-type="if"] {
            border-color: #eab308;
            background: linear-gradient(135deg, #713f12 0%, #18181b 100%);
        }

        .dag-node[data-type="branch"] {
            border-color: #eab308;
            background: linear-gradient(135deg, #713f12 0%, #18181b 100%);
        }

        .dag-node[data-type="spread_action"] {
            border-color: #ec4899;
            background: linear-gradient(135deg, #831843 0%, #18181b 100%);
        }

        .dag-node[data-type="aggregator"] {
            border-color: #10b981;
            background: linear-gradient(135deg, #064e3b 0%, #18181b 100%);
        }

        .dag-node[data-type="join"] {
            border-color: #6366f1;
            background: linear-gradient(135deg, #312e81 0%, #18181b 100%);
        }

        .edge-control {
            stroke: #4b5563;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .edge-data {
            stroke: #a855f7;
            stroke-width: 2;
            stroke-dasharray: 6, 4;
            fill: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            marker-end: url(#arrowhead-data);
        }

        .edge-data.visible {
            opacity: 1;
        }

        .edge-label {
            font-family: 'SF Mono', monospace;
            font-size: 10px;
            fill: #c084fc;
            font-weight: 500;
            transition: opacity 0.2s ease;
        }

        .edge-label.visible {
            opacity: 1 !important;
        }

        .edge-loop-back {
            stroke: #06b6d4;
            stroke-width: 2;
            stroke-dasharray: 8, 4;
        }

        .legend {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 12px;
            font-size: 11px;
            z-index: 100;
        }

        .legend-title {
            font-weight: 600;
            color: #a1a1aa;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }

        .legend-color {
            width: 24px;
            height: 4px;
            border-radius: 2px;
        }

        .legend-color.control {
            background: #4b5563;
        }

        .legend-color.data {
            background: #a855f7;
            background: repeating-linear-gradient(
                90deg,
                #a855f7,
                #a855f7 6px,
                transparent 6px,
                transparent 10px
            );
        }

        .legend-color.loop-back {
            background: #06b6d4;
            background: repeating-linear-gradient(
                90deg,
                #06b6d4,
                #06b6d4 8px,
                transparent 8px,
                transparent 12px
            );
        }

        .help-text {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 11px;
            color: #71717a;
            z-index: 100;
        }

        /* Node type legend */
        .node-legend {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 12px;
            font-size: 11px;
            z-index: 100;
        }

        .node-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }

        .node-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 4px;
            border: 2px solid;
        }

        .node-legend-color.input { border-color: #22c55e; background: #14532d; }
        .node-legend-color.output { border-color: #f97316; background: #7c2d12; }
        .node-legend-color.action { border-color: #3b82f6; background: #1e3a5f; }
        .node-legend-color.assignment { border-color: #8b5cf6; background: #4c1d95; }
        .node-legend-color.for-loop { border-color: #06b6d4; background: #164e63; }
        .node-legend-color.branch { border-color: #eab308; background: #713f12; }
        .node-legend-color.spread { border-color: #ec4899; background: #831843; }
        .node-legend-color.join { border-color: #6366f1; background: #312e81; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Rappel DAG Visualizer</h1>
        <span class="badge">Interactive</span>
    </div>

    <div class="container">
        <div class="panel">
            <div class="panel-header">
                <div class="icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <h2>Python Source</h2>
            </div>
            <div class="panel-content">
                <pre id="python-source"></pre>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M9 9h6M9 12h6M9 15h4"/>
                    </svg>
                </div>
                <h2>Intermediate Representation (IR)</h2>
            </div>
            <div class="panel-content">
                <pre id="ir-text"></pre>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2">
                        <circle cx="12" cy="5" r="3"/>
                        <circle cx="5" cy="19" r="3"/>
                        <circle cx="19" cy="19" r="3"/>
                        <path d="M12 8v4M9 16l-2.5-4M15 16l2.5-4"/>
                    </svg>
                </div>
                <h2>Execution DAG</h2>
            </div>
            <div class="panel-content">
                <div class="dag-container" id="dag-container">
                    <svg class="dag-svg" id="dag-svg">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#4b5563"/>
                            </marker>
                            <marker id="arrowhead-data" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#a855f7"/>
                            </marker>
                        </defs>
                    </svg>
                    <div class="dag-nodes" id="dag-nodes"></div>

                    <div class="legend">
                        <div class="legend-title">Edge Types</div>
                        <div class="legend-item">
                            <div class="legend-color control"></div>
                            <span>Control Flow</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color data"></div>
                            <span>Data Flow (click node)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color loop-back"></div>
                            <span>Loop Back</span>
                        </div>
                    </div>

                    <div class="help-text">
                        Click a node to see data flow edges
                    </div>

                    <div class="node-legend">
                        <div class="legend-title">Node Types</div>
                        <div class="node-legend-item">
                            <div class="node-legend-color input"></div>
                            <span>Input/Output</span>
                        </div>
                        <div class="node-legend-item">
                            <div class="node-legend-color action"></div>
                            <span>Action Call</span>
                        </div>
                        <div class="node-legend-item">
                            <div class="node-legend-color assignment"></div>
                            <span>Assignment</span>
                        </div>
                        <div class="node-legend-item">
                            <div class="node-legend-color for-loop"></div>
                            <span>For Loop</span>
                        </div>
                        <div class="node-legend-item">
                            <div class="node-legend-color branch"></div>
                            <span>Branch</span>
                        </div>
                        <div class="node-legend-item">
                            <div class="node-legend-color spread"></div>
                            <span>Parallel/Spread</span>
                        </div>
                        <div class="node-legend-item">
                            <div class="node-legend-color join"></div>
                            <span>Join</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const data = {"python_source":"\"\"\"\nRappel Workflow demonstrating all language features.\n\nThis workflow showcases every supported pattern in the Rappel IR:\n1. Simple assignments (literals, expressions)\n2. Action calls with keyword arguments\n3. Parallel execution (asyncio.gather)\n4. Spread actions (parallel iteration over collections)\n5. For loops (sequential iteration)\n6. Conditionals (if/elif/else)\n7. Try/except (exception handling)\n8. Tuple unpacking from parallel calls\n9. List operations (literals, concatenation)\n10. Return statements\n\"\"\"\n\nimport asyncio\nfrom typing import Any\n\nfrom rappel import action, workflow\nfrom rappel.workflow import Workflow\n\n\n# =============================================================================\n# Exception for demonstrating try/except\n# =============================================================================\n\n\nclass NetworkError(Exception):\n    \"\"\"Simulated network error for exception handling demo.\"\"\"\n    pass\n\n\n# =============================================================================\n# Actions for demonstrating various patterns\n# =============================================================================\n\n\n@action\nasync def check_status_a(service: str) -> dict[str, Any]:\n    \"\"\"Check status of service A - used in parallel execution.\"\"\"\n    return {\"service\": service, \"status\": \"healthy\", \"latency_ms\": 42}\n\n\n@action\nasync def check_status_b(service: str) -> dict[str, Any]:\n    \"\"\"Check status of service B - used in parallel execution.\"\"\"\n    return {\"service\": service, \"status\": \"healthy\", \"latency_ms\": 38}\n\n\n@action\nasync def process_item(item: Any) -> dict[str, Any]:\n    \"\"\"Process a single item - used in spread actions.\"\"\"\n    return {\"item\": item, \"processed\": True, \"result\": item * 2 if isinstance(item, int) else str(item)}\n\n\n@action\nasync def validate_item(item: Any, index: int) -> dict[str, Any]:\n    \"\"\"Validate an item at a given index - used in for loops.\"\"\"\n    return {\"index\": index, \"item\": item, \"valid\": True}\n\n\n@action\nasync def handle_overflow(count: int) -> str:\n    \"\"\"Handle case when count exceeds threshold.\"\"\"\n    return f\"overflow_handled:{count}\"\n\n\n@action\nasync def handle_threshold(count: int) -> str:\n    \"\"\"Handle case when count equals threshold.\"\"\"\n    return f\"at_threshold:{count}\"\n\n\n@action\nasync def handle_normal(count: int) -> str:\n    \"\"\"Handle normal case when count is below threshold.\"\"\"\n    return f\"normal:{count}\"\n\n\n@action\nasync def risky_operation(data: list) -> dict[str, Any]:\n    \"\"\"An operation that might fail - used in try/except.\"\"\"\n    return {\"success\": True, \"data_length\": len(data)}\n\n\n@action\nasync def fallback_operation(data: list) -> dict[str, Any]:\n    \"\"\"Fallback when risky_operation fails.\"\"\"\n    return {\"fallback\": True, \"data_length\": len(data)}\n\n\n@action\nasync def aggregate_results(items: list, status_a: dict, status_b: dict, final_status: str) -> dict[str, Any]:\n    \"\"\"Aggregate all results into a final summary.\"\"\"\n    return {\n        \"total_items\": len(items),\n        \"status_a\": status_a,\n        \"status_b\": status_b,\n        \"final_status\": final_status,\n        \"complete\": True\n    }\n\n\n# =============================================================================\n# Complete Feature Demonstration Workflow\n# =============================================================================\n\n\n@workflow\nclass CompleteFeatureWorkflow(Workflow):\n    \"\"\"\n    A workflow demonstrating all Rappel language features.\n\n    This workflow:\n    1. Initializes variables with simple assignments\n    2. Executes parallel status checks (asyncio.gather)\n    3. Uses spread to process items in parallel\n    4. Iterates sequentially with a for loop\n    5. Makes conditional decisions (if/elif/else)\n    6. Handles exceptions with try/except\n    7. Aggregates everything into a final result\n    \"\"\"\n\n    async def run(self, items: list, threshold: int) -> dict[str, Any]:\n        # 1. Simple assignments\n        count = 0\n        results = []\n\n        # 2. Parallel execution (asyncio.gather with multiple calls)\n        status_a, status_b = await asyncio.gather(\n            check_status_a(service=\"alpha\"),\n            check_status_b(service=\"beta\"),\n        )\n\n        # 3. Spread action (parallel iteration over a collection)\n        processed = await asyncio.gather(*[\n            process_item(item=x) for x in items\n        ])\n\n        # 4. For loop with single action per iteration\n        for i, item in enumerate(processed):\n            item_result = await validate_item(item=item, index=i)\n            results = results + [item_result]\n\n        # 5. Conditional (if/elif/else)\n        if count > threshold:\n            final_status = await handle_overflow(count=count)\n        elif count == threshold:\n            final_status = await handle_threshold(count=count)\n        else:\n            final_status = await handle_normal(count=count)\n\n        # 6. Try/except with exception handling\n        try:\n            risky_result = await risky_operation(data=results)\n        except NetworkError:\n            risky_result = await fallback_operation(data=results)\n\n        # 7. Final aggregation and return\n        summary = await aggregate_results(\n            items=processed,\n            status_a=status_a,\n            status_b=status_b,\n            final_status=final_status,\n        )\n\n        return summary\n","ir_text":"fn __for_body_1__(input: [i, item, results], output: [results]):\n    item_result = @validate_item(item=item, index=i)\n    results = (results + [item_result])\n    return results\n\nfn __if_then_2__(input: [], output: []):\n    final_status = @handle_overflow(count=count)\n\nfn __if_elif_3__(input: [], output: []):\n    final_status = @handle_threshold(count=count)\n\nfn __if_else_4__(input: [], output: []):\n    final_status = @handle_normal(count=count)\n\nfn __try_body_5__(input: [results, risky_result], output: [risky_result]):\n    risky_result = @risky_operation(data=results)\n    return risky_result\n\nfn __except_handler_6__(input: [results, risky_result], output: [risky_result]):\n    risky_result = @fallback_operation(data=results)\n    return risky_result\n\nfn run(input: [items, threshold], output: []):\n    count = 0\n    results = []\n    status_a, status_b = parallel:\n        @check_status_a(service=\"alpha\")\n        @check_status_b(service=\"beta\")\n    processed = spread items:x -> @process_item(item=x)\n    for i, item in enumerate(processed):\n            results = __for_body_1__(i=i, item=item, results=results)\n    if (count > threshold):\n            __if_then_2__()\n    elif (count == threshold):\n            __if_elif_3__()\n    else:\n            __if_else_4__()\n    try:\n            risky_result = __try_body_5__(results=results, risky_result=risky_result)\n        except NetworkError:\n            risky_result = __except_handler_6__(results=results, risky_result=risky_result)\n    summary = @aggregate_results(items=processed, status_a=status_a, status_b=status_b, final_status=final_status)\n    return summary","dag":{"nodes":[{"id":"action_47","node_type":"action_call","label":"@aggregate_results() -> summary","action_name":"aggregate_results","targets":["summary"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"aggregator_31","node_type":"aggregator","label":"aggregate -> processed","targets":["processed"],"is_input":false,"is_output":false,"is_aggregator":true,"is_spread":false},{"id":"assign_24","node_type":"assignment","label":"count = ...","targets":["count"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"assign_25","node_type":"assignment","label":"results = ...","targets":["results"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"branch_39","node_type":"branch","label":"branch","is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"fn_call_36:action_2","node_type":"action_call","label":"@validate_item() -> item_result","action_name":"validate_item","targets":["item_result"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"fn_call_36:assign_3","node_type":"assignment","label":"results = ...","targets":["results"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"fn_call_40:action_7","node_type":"action_call","label":"@handle_overflow() -> final_status","action_name":"handle_overflow","targets":["final_status"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"fn_call_41:action_10","node_type":"action_call","label":"@handle_threshold() -> final_status","action_name":"handle_threshold","targets":["final_status"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"fn_call_42:action_13","node_type":"action_call","label":"@handle_normal() -> final_status","action_name":"handle_normal","targets":["final_status"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"fn_call_44:action_16","node_type":"action_call","label":"@risky_operation() -> risky_result","action_name":"risky_operation","targets":["risky_result"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"fn_call_46:action_20","node_type":"action_call","label":"@fallback_operation() -> risky_result","action_name":"fallback_operation","targets":["risky_result"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"join_43","node_type":"join","label":"join","is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"join_45","node_type":"join","label":"join","is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"loop_cond_34","node_type":"branch","label":"for i, item in enumerate($processed)","is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"loop_exit_38","node_type":"join","label":"end for i, item","targets":["results"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"loop_extract_35","node_type":"assignment","label":"i, item = enumerate($processed)[__loop_loop_32_i]","targets":["i","item"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"loop_incr_37","node_type":"assignment","label":"__loop_loop_32_i = __loop_loop_32_i + 1","targets":["__loop_loop_32_i"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"loop_init_33","node_type":"assignment","label":"__loop_loop_32_i = 0","targets":["__loop_loop_32_i"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"parallel_26","node_type":"parallel","label":"parallel","is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"parallel_action_27","node_type":"action_call","label":"@check_status_a() [0] -> status_a","action_name":"check_status_a","targets":["status_a"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"parallel_action_28","node_type":"action_call","label":"@check_status_b() [1] -> status_b","action_name":"check_status_b","targets":["status_b"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"parallel_aggregator_29","node_type":"aggregator","label":"parallel_aggregate -> (status_a, status_b)","targets":["status_a","status_b"],"is_input":false,"is_output":false,"is_aggregator":true,"is_spread":false},{"id":"return_48","node_type":"return","label":"return","is_input":false,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"run_input_23","node_type":"input","label":"input: [items, threshold]","is_input":true,"is_output":false,"is_aggregator":false,"is_spread":false},{"id":"run_output_49","node_type":"output","label":"output: []","is_input":false,"is_output":true,"is_aggregator":false,"is_spread":false},{"id":"spread_action_30","node_type":"action_call","label":"@process_item() [spread over x]","action_name":"process_item","targets":["_spread_result"],"is_input":false,"is_output":false,"is_aggregator":false,"is_spread":true}],"edges":[{"source":"fn_call_44:action_16","target":"fn_call_46:action_20","edge_type":"control_flow","condition":"except:NetworkError","is_loop_back":false},{"source":"fn_call_36:action_2","target":"fn_call_36:assign_3","edge_type":"control_flow","is_loop_back":false},{"source":"run_input_23","target":"assign_24","edge_type":"control_flow","is_loop_back":false},{"source":"assign_24","target":"assign_25","edge_type":"control_flow","is_loop_back":false},{"source":"parallel_26","target":"parallel_action_27","edge_type":"control_flow","condition":"parallel:0","is_loop_back":false},{"source":"parallel_26","target":"parallel_action_28","edge_type":"control_flow","condition":"parallel:1","is_loop_back":false},{"source":"parallel_action_27","target":"parallel_aggregator_29","edge_type":"control_flow","is_loop_back":false},{"source":"parallel_action_28","target":"parallel_aggregator_29","edge_type":"control_flow","is_loop_back":false},{"source":"assign_25","target":"parallel_26","edge_type":"control_flow","is_loop_back":false},{"source":"spread_action_30","target":"aggregator_31","edge_type":"control_flow","is_loop_back":false},{"source":"parallel_aggregator_29","target":"spread_action_30","edge_type":"control_flow","is_loop_back":false},{"source":"loop_init_33","target":"loop_cond_34","edge_type":"control_flow","is_loop_back":false},{"source":"loop_cond_34","target":"loop_extract_35","edge_type":"control_flow","condition":"guarded","is_loop_back":false},{"source":"loop_extract_35","target":"fn_call_36:action_2","edge_type":"control_flow","is_loop_back":false},{"source":"fn_call_36:assign_3","target":"loop_incr_37","edge_type":"control_flow","is_loop_back":false},{"source":"loop_incr_37","target":"loop_cond_34","edge_type":"control_flow","is_loop_back":true},{"source":"loop_cond_34","target":"loop_exit_38","edge_type":"control_flow","condition":"guarded","is_loop_back":false},{"source":"aggregator_31","target":"loop_init_33","edge_type":"control_flow","is_loop_back":false},{"source":"branch_39","target":"fn_call_40:action_7","edge_type":"control_flow","condition":"guarded","is_loop_back":false},{"source":"branch_39","target":"fn_call_41:action_10","edge_type":"control_flow","condition":"guarded","is_loop_back":false},{"source":"fn_call_41:action_10","target":"join_43","edge_type":"control_flow","is_loop_back":false},{"source":"branch_39","target":"fn_call_42:action_13","edge_type":"control_flow","condition":"guarded","is_loop_back":false},{"source":"fn_call_40:action_7","target":"join_43","edge_type":"control_flow","is_loop_back":false},{"source":"fn_call_42:action_13","target":"join_43","edge_type":"control_flow","is_loop_back":false},{"source":"loop_exit_38","target":"branch_39","edge_type":"control_flow","is_loop_back":false},{"source":"fn_call_44:action_16","target":"join_45","edge_type":"control_flow","condition":"success","is_loop_back":false},{"source":"fn_call_46:action_20","target":"join_45","edge_type":"control_flow","is_loop_back":false},{"source":"join_43","target":"fn_call_44:action_16","edge_type":"control_flow","is_loop_back":false},{"source":"join_45","target":"action_47","edge_type":"control_flow","is_loop_back":false},{"source":"action_47","target":"return_48","edge_type":"control_flow","is_loop_back":false},{"source":"return_48","target":"run_output_49","edge_type":"control_flow","is_loop_back":false},{"source":"assign_24","target":"branch_39","edge_type":"data_flow","variable":"count","is_loop_back":false},{"source":"assign_24","target":"fn_call_42:action_13","edge_type":"data_flow","variable":"count","is_loop_back":false},{"source":"assign_24","target":"fn_call_41:action_10","edge_type":"data_flow","variable":"count","is_loop_back":false},{"source":"assign_24","target":"fn_call_40:action_7","edge_type":"data_flow","variable":"count","is_loop_back":false},{"source":"action_47","target":"return_48","edge_type":"data_flow","variable":"summary","is_loop_back":false},{"source":"fn_call_36:action_2","target":"fn_call_36:assign_3","edge_type":"data_flow","variable":"item_result","is_loop_back":false},{"source":"parallel_aggregator_29","target":"action_47","edge_type":"data_flow","variable":"status_a","is_loop_back":false},{"source":"run_input_23","target":"branch_39","edge_type":"data_flow","variable":"threshold","is_loop_back":false},{"source":"fn_call_40:action_7","target":"action_47","edge_type":"data_flow","variable":"final_status","is_loop_back":false},{"source":"loop_init_33","target":"loop_cond_34","edge_type":"data_flow","variable":"__loop_loop_32_i","is_loop_back":false},{"source":"loop_init_33","target":"loop_extract_35","edge_type":"data_flow","variable":"__loop_loop_32_i","is_loop_back":false},{"source":"loop_init_33","target":"loop_incr_37","edge_type":"data_flow","variable":"__loop_loop_32_i","is_loop_back":false},{"source":"parallel_aggregator_29","target":"action_47","edge_type":"data_flow","variable":"status_b","is_loop_back":false},{"source":"loop_extract_35","target":"fn_call_36:action_2","edge_type":"data_flow","variable":"i","is_loop_back":false},{"source":"loop_extract_35","target":"fn_call_36:action_2","edge_type":"data_flow","variable":"item","is_loop_back":false},{"source":"assign_25","target":"fn_call_44:action_16","edge_type":"data_flow","variable":"results","is_loop_back":false},{"source":"assign_25","target":"fn_call_46:action_20","edge_type":"data_flow","variable":"results","is_loop_back":false},{"source":"assign_25","target":"fn_call_36:assign_3","edge_type":"data_flow","variable":"results","is_loop_back":false},{"source":"aggregator_31","target":"loop_cond_34","edge_type":"data_flow","variable":"processed","is_loop_back":false},{"source":"aggregator_31","target":"loop_extract_35","edge_type":"data_flow","variable":"processed","is_loop_back":false},{"source":"fn_call_36:action_2","target":"fn_call_36:action_2","edge_type":"data_flow","variable":"item_result","is_loop_back":false},{"source":"loop_incr_37","target":"loop_cond_34","edge_type":"data_flow","variable":"__loop_loop_32_i","is_loop_back":false},{"source":"loop_incr_37","target":"loop_extract_35","edge_type":"data_flow","variable":"__loop_loop_32_i","is_loop_back":false},{"source":"loop_incr_37","target":"loop_incr_37","edge_type":"data_flow","variable":"__loop_loop_32_i","is_loop_back":false},{"source":"loop_extract_35","target":"loop_extract_35","edge_type":"data_flow","variable":"i","is_loop_back":false},{"source":"loop_extract_35","target":"loop_extract_35","edge_type":"data_flow","variable":"item","is_loop_back":false},{"source":"fn_call_36:assign_3","target":"fn_call_44:action_16","edge_type":"data_flow","variable":"results","is_loop_back":false},{"source":"fn_call_36:assign_3","target":"fn_call_46:action_20","edge_type":"data_flow","variable":"results","is_loop_back":false},{"source":"fn_call_36:assign_3","target":"fn_call_36:assign_3","edge_type":"data_flow","variable":"results","is_loop_back":false},{"source":"loop_incr_37","target":"loop_cond_34","edge_type":"data_flow","variable":"__loop_loop_32_i","is_loop_back":false},{"source":"loop_incr_37","target":"loop_cond_34","edge_type":"data_flow","variable":"__loop_loop_32_i","is_loop_back":false},{"source":"spread_action_30","target":"aggregator_31","edge_type":"data_flow","variable":"_spread_result","is_loop_back":false},{"source":"parallel_action_27","target":"action_47","edge_type":"data_flow","variable":"status_a","is_loop_back":false},{"source":"aggregator_31","target":"action_47","edge_type":"data_flow","variable":"processed","is_loop_back":false},{"source":"parallel_action_28","target":"action_47","edge_type":"data_flow","variable":"status_b","is_loop_back":false}]}};

        // Display Python source
        document.getElementById('python-source').textContent = data.python_source;

        // Display IR text
        document.getElementById('ir-text').textContent = data.ir_text;

        // Build DAG visualization
        const container = document.getElementById('dag-container');
        const svg = document.getElementById('dag-svg');
        const nodesContainer = document.getElementById('dag-nodes');

        const nodes = data.dag.nodes;
        const edges = data.dag.edges;

        // Build adjacency info
        const nodeMap = new Map(nodes.map(n => [n.id, n]));
        const incomingEdges = new Map();
        const outgoingEdges = new Map();

        edges.forEach(edge => {
            if (!incomingEdges.has(edge.target)) incomingEdges.set(edge.target, []);
            if (!outgoingEdges.has(edge.source)) outgoingEdges.set(edge.source, []);
            incomingEdges.get(edge.target).push(edge);
            outgoingEdges.get(edge.source).push(edge);
        });

        // Compute topological depth
        const depthCache = new Map();
        function computeDepth(nodeId, visited = new Set()) {
            if (depthCache.has(nodeId)) return depthCache.get(nodeId);
            if (visited.has(nodeId)) return 0;
            visited.add(nodeId);

            const incoming = (incomingEdges.get(nodeId) || [])
                .filter(e => e.edge_type === 'control_flow' && !e.is_loop_back);

            let maxDepth = 0;
            incoming.forEach(edge => {
                maxDepth = Math.max(maxDepth, computeDepth(edge.source, visited) + 1);
            });

            depthCache.set(nodeId, maxDepth);
            return maxDepth;
        }

        nodes.forEach(n => computeDepth(n.id));

        // Group by depth
        const levels = [];
        nodes.forEach(node => {
            const depth = depthCache.get(node.id) || 0;
            if (!levels[depth]) levels[depth] = [];
            levels[depth].push(node);
        });

        // Layout parameters
        const padding = 40;
        const topPadding = 150;  // Extra space at top for data flow arcs
        const columnGap = 260;
        const rowGap = 100;
        const nodeWidth = 180;
        const nodeHeight = 70;

        // Position nodes
        const positions = new Map();
        let maxX = 0;
        let maxY = 0;

        levels.forEach((levelNodes, depth) => {
            levelNodes.forEach((node, index) => {
                const x = padding + depth * columnGap;
                const y = topPadding + index * rowGap;
                positions.set(node.id, { x, y, cx: x + nodeWidth / 2, cy: y + nodeHeight / 2 });
                maxX = Math.max(maxX, x + nodeWidth);
                maxY = Math.max(maxY, y + nodeHeight);
            });
        });

        // Set SVG size (extra space at top for data flow arcs)
        svg.setAttribute('width', maxX + padding);
        svg.setAttribute('height', maxY + padding);
        container.style.minWidth = (maxX + padding) + 'px';
        container.style.minHeight = (maxY + padding) + 'px';

        // Draw edges
        const edgeElements = new Map();

        // Track data flow edge indices for vertical offset
        const dataFlowIndex = new Map();

        edges.forEach((edge, idx) => {
            const start = positions.get(edge.source);
            const end = positions.get(edge.target);
            if (!start || !end) return;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const isDataFlow = edge.edge_type === 'data_flow';

            // Calculate path
            let d;
            if (isDataFlow) {
                // Data flow edges: arc ABOVE the graph with variable heights
                const edgeKey = `${edge.source}->${edge.target}`;
                let offsetIdx = dataFlowIndex.get(edge.target) || 0;
                dataFlowIndex.set(edge.target, offsetIdx + 1);

                // Calculate arc height based on horizontal distance and index
                const dx = Math.abs(end.cx - start.cx);
                const baseArcHeight = Math.max(80, dx * 0.3);
                const arcHeight = baseArcHeight + (offsetIdx * 25);

                // Start from top of source node, end at top of target node
                const startX = start.cx;
                const startY = start.y - 5;
                const endX = end.cx;
                const endY = end.y - 5;

                // Control point for the arc (above both nodes)
                const midX = (startX + endX) / 2;
                const midY = Math.min(startY, endY) - arcHeight;

                d = `M${startX},${startY} Q${midX},${midY} ${endX},${endY}`;
            } else if (edge.is_loop_back) {
                // Loop back: curve around below
                const midY = Math.max(start.cy, end.cy) + 60;
                d = `M${start.cx + nodeWidth/2},${start.cy}
                     Q${start.cx + nodeWidth/2 + 40},${midY} ${end.cx},${end.cy + nodeHeight/2}`;
            } else if (start.x > end.x) {
                // Backward control flow edge
                const midY = Math.min(start.cy, end.cy) - 50;
                d = `M${start.cx - nodeWidth/2},${start.cy}
                     Q${(start.cx + end.cx)/2},${midY} ${end.cx + nodeWidth/2},${end.cy}`;
            } else {
                // Forward control flow edge
                const dx = end.cx - start.cx;
                d = `M${start.cx + nodeWidth/2},${start.cy}
                     C${start.cx + nodeWidth/2 + dx/3},${start.cy}
                      ${end.cx - nodeWidth/2 - dx/3},${end.cy}
                      ${end.cx - nodeWidth/2},${end.cy}`;
            }

            path.setAttribute('d', d);

            if (isDataFlow) {
                path.classList.add('edge-data');
                path.dataset.target = edge.target;
                path.dataset.source = edge.source;
                if (edge.variable) {
                    path.dataset.variable = edge.variable;
                }

                // Add variable label on the arc
                if (edge.variable) {
                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    const offsetIdx = (dataFlowIndex.get(edge.target) || 1) - 1;
                    const dx = Math.abs(end.cx - start.cx);
                    const baseArcHeight = Math.max(80, dx * 0.3);
                    const arcHeight = baseArcHeight + (offsetIdx * 25);
                    const midX = (start.cx + end.cx) / 2;
                    const midY = Math.min(start.y, end.y) - arcHeight - 5;

                    label.setAttribute('x', midX);
                    label.setAttribute('y', midY);
                    label.setAttribute('text-anchor', 'middle');
                    label.setAttribute('class', 'edge-label');
                    label.textContent = edge.variable;
                    label.style.opacity = '0';
                    label.dataset.target = edge.target;
                    svg.appendChild(label);

                    if (!edgeElements.has(edge.target)) edgeElements.set(edge.target, []);
                    edgeElements.get(edge.target).push(label);
                }
            } else {
                path.classList.add('edge-control');
                if (edge.is_loop_back) {
                    path.classList.add('edge-loop-back');
                }
            }

            svg.appendChild(path);

            if (isDataFlow) {
                if (!edgeElements.has(edge.target)) edgeElements.set(edge.target, []);
                edgeElements.get(edge.target).push(path);
            }
        });

        // Create node elements
        let selectedNode = null;

        nodes.forEach(node => {
            const pos = positions.get(node.id);
            if (!pos) return;

            const el = document.createElement('div');
            el.className = 'dag-node';

            // Determine node type for styling
            let dataType = node.node_type;
            if (node.is_input) dataType = 'input';
            else if (node.is_output) dataType = 'output';
            else if (node.is_aggregator) dataType = 'aggregator';
            else if (node.is_spread) dataType = 'spread_action';
            else if (node.node_type === 'branch' || node.node_type === 'if') dataType = 'branch';
            else if (node.node_type === 'join') dataType = 'join';

            el.dataset.type = dataType;
            el.style.left = pos.x + 'px';
            el.style.top = pos.y + 'px';
            el.style.width = nodeWidth + 'px';

            // Build label
            let label = node.label;
            if (node.action_name) {
                label = '@' + node.action_name;
            } else if (label.length > 25) {
                label = label.substring(0, 22) + '...';
            }

            el.innerHTML = `
                <div class="node-id">${node.id}</div>
                <div class="node-label">${label}</div>
                <div class="node-type">${node.node_type}${node.targets ? ' -> ' + node.targets.join(', ') : ''}</div>
            `;

            // Click handler to show data flow edges
            el.addEventListener('click', () => {
                // Deselect previous
                if (selectedNode) {
                    selectedNode.classList.remove('selected');
                    const prevEdges = edgeElements.get(selectedNode.dataset.nodeId) || [];
                    prevEdges.forEach(e => e.classList.remove('visible'));
                }

                // Toggle selection
                if (selectedNode === el) {
                    selectedNode = null;
                } else {
                    selectedNode = el;
                    el.classList.add('selected');
                    el.dataset.nodeId = node.id;

                    // Show incoming data edges
                    const nodeEdges = edgeElements.get(node.id) || [];
                    nodeEdges.forEach(e => e.classList.add('visible'));
                }
            });

            el.dataset.nodeId = node.id;
            nodesContainer.appendChild(el);
        });

        // Click outside to deselect
        container.addEventListener('click', (e) => {
            if (e.target === container || e.target === nodesContainer) {
                if (selectedNode) {
                    selectedNode.classList.remove('selected');
                    const prevEdges = edgeElements.get(selectedNode.dataset.nodeId) || [];
                    prevEdges.forEach(e => e.classList.remove('visible'));
                    selectedNode = null;
                }
            }
        });
    </script>
</body>
</html>
