name: CI

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  python-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Python lint
        run: make python-lint-verify

  python-tests:
    runs-on: ubuntu-latest
    needs: python-lint
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Python tests with coverage
        run: make python-coverage
        env:
          UV_PYTHON: ${{ matrix.python-version }}

      - name: Upload Python coverage XML
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: python-coverage
          path: python/coverage.xml

      - name: Upload Python coverage HTML
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: python-coverage-html
          path: python/htmlcov

  rust-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Rust cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          shared-key: rappel

      - name: Rust lint
        run: make rust-lint-verify

  rust-tests:
    runs-on: ubuntu-latest
    needs: rust-lint
    timeout-minutes: 10
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mountaineer
          POSTGRES_PASSWORD: mountaineer
          POSTGRES_DB: mountaineer_daemons
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U mountaineer"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Prepare Python worker environment
        working-directory: python
        run: uv sync

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt, llvm-tools-preview

      - name: Rust cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          shared-key: rappel

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Run tests with coverage
        env:
          RAPPEL_DATABASE_URL: postgresql://mountaineer:mountaineer@localhost:5432/mountaineer_daemons
        run: make rust-coverage

      - name: Upload Rust coverage LCOV
        uses: actions/upload-artifact@v4
        with:
          name: rust-coverage
          path: target/rust-coverage.lcov

      - name: Upload Rust coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: rust-coverage-html
          path: target/rust-htmlcov

  main-coverage:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 15
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mountaineer
          POSTGRES_PASSWORD: mountaineer
          POSTGRES_DB: mountaineer_daemons
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U mountaineer"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Prepare Python worker environment
        working-directory: python
        run: uv sync

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt, llvm-tools-preview

      - name: Rust cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          shared-key: rappel

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Python tests with coverage
        run: make python-coverage

      - name: Rust tests with coverage
        env:
          RAPPEL_DATABASE_URL: postgresql://mountaineer:mountaineer@localhost:5432/mountaineer_daemons
        run: make rust-coverage

      - name: Upload main Python coverage XML
        uses: actions/upload-artifact@v4
        with:
          name: main-python-coverage
          path: python/coverage.xml

      - name: Upload main Rust coverage LCOV
        uses: actions/upload-artifact@v4
        with:
          name: main-rust-coverage
          path: target/rust-coverage.lcov

  coverage-report:
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests, main-coverage]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Download Python coverage XML
        uses: actions/download-artifact@v4
        with:
          name: python-coverage
          path: coverage/pr/python

      - name: Download Rust coverage LCOV
        uses: actions/download-artifact@v4
        with:
          name: rust-coverage
          path: coverage/pr/rust

      - name: Download main Python coverage XML
        uses: actions/download-artifact@v4
        with:
          name: main-python-coverage
          path: coverage/main/python

      - name: Download main Rust coverage LCOV
        uses: actions/download-artifact@v4
        with:
          name: main-rust-coverage
          path: coverage/main/rust

      - name: Get artifact URLs
        id: artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            const pythonHtml = artifacts.data.artifacts.find(a => a.name === 'python-coverage-html');
            const rustHtml = artifacts.data.artifacts.find(a => a.name === 'rust-coverage-html');

            const baseUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts`;

            core.setOutput('python_html_url', pythonHtml ? `${baseUrl}/${pythonHtml.id}` : '');
            core.setOutput('rust_html_url', rustHtml ? `${baseUrl}/${rustHtml.id}` : '');

      - name: Generate coverage comment
        run: |
          uv run scripts/coverage_report.py \
            --python-xml coverage/pr/python/coverage.xml \
            --rust-lcov coverage/pr/rust/rust-coverage.lcov \
            --main-python-xml coverage/main/python/coverage.xml \
            --main-rust-lcov coverage/main/rust/rust-coverage.lcov \
            --python-html-url "${{ steps.artifacts.outputs.python_html_url }}" \
            --rust-html-url "${{ steps.artifacts.outputs.rust_html_url }}" \
            --format comment \
            --output coverage-comment.md

      - name: Post coverage comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage-report
          path: coverage-comment.md

  benchmark:
    runs-on: ubuntu-latest
    needs: [rust-tests]
    timeout-minutes: 15
    if: github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build')
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mountaineer
          POSTGRES_PASSWORD: mountaineer
          POSTGRES_DB: mountaineer_daemons
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U mountaineer"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc & clients
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler postgresql-client

      - name: Prepare Python worker environment
        working-directory: python
        run: uv sync

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          shared-key: rappel

      - name: Build release binary
        run: cargo build --release

      - name: Run benchmarks on PR branch
        env:
          RAPPEL_DATABASE_URL: postgresql://mountaineer:mountaineer@localhost:5432/mountaineer_daemons
        run: uv run scripts/run_benchmarks.py suite --format json --output benchmark-pr.json --benchmark-config "for-loop:1000:0,fan-out:1000:0,queue-noop:5000:0"

      - name: Save benchmark code diff
        run: git diff origin/main -- src/benchmark/ > benchmark-diff.txt || true

      - name: Upload PR benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-pr
          path: |
            benchmark-pr.json
            benchmark-diff.txt

  benchmark-main:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build')
    timeout-minutes: 15
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mountaineer
          POSTGRES_PASSWORD: mountaineer
          POSTGRES_DB: mountaineer_daemons
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U mountaineer"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Checkout benchmark scripts from PR
        run: |
          git fetch origin ${{ github.event.pull_request.head.sha }}
          git checkout ${{ github.event.pull_request.head.sha }} -- scripts/run_benchmarks.py scripts/benchmark_report.py

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc & clients
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler postgresql-client

      - name: Prepare Python worker environment
        working-directory: python
        run: uv sync

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          shared-key: rappel

      - name: Build release binary
        run: cargo build --release

      - name: Run benchmarks on main branch
        env:
          RAPPEL_DATABASE_URL: postgresql://mountaineer:mountaineer@localhost:5432/mountaineer_daemons
        run: uv run scripts/run_benchmarks.py suite --format json --output benchmark-main.json --benchmark-config "for-loop:1000:0,fan-out:1000:0,queue-noop:5000:0"

      - name: Upload main benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-main
          path: benchmark-main.json

  benchmark-report:
    runs-on: ubuntu-latest
    needs: [benchmark, benchmark-main]
    if: github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build')
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Download PR benchmark results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-pr
          path: results/pr

      - name: Download main benchmark results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-main
          path: results/main

      - name: Generate benchmark report
        run: |
          uv run scripts/benchmark_report.py \
            --pr-json results/pr/benchmark-pr.json \
            --main-json results/main/benchmark-main.json \
            --benchmark-diff results/pr/benchmark-diff.txt \
            --pr-sha "${{ github.event.pull_request.head.sha }}" \
            --main-sha "${{ github.sha }}" \
            --format markdown \
            --output benchmark-comment.md

      - name: Post benchmark comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: benchmark-report
          path: benchmark-comment.md

  integration:
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests]
    timeout-minutes: 10
    if: github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build'))
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mountaineer
          POSTGRES_PASSWORD: mountaineer
          POSTGRES_DB: mountaineer_daemons
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U mountaineer"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc & clients
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler postgresql-client

      - name: Prepare Python worker environment
        working-directory: python
        run: uv sync

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Rust cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          shared-key: rappel

      - name: Wait for Postgres
        run: pg_isready --host=localhost --port=5432 --username=mountaineer --dbname=mountaineer_daemons

      - name: Run integration tests
        env:
          RAPPEL_DATABASE_URL: postgresql://mountaineer:mountaineer@localhost:5432/mountaineer_daemons
        run: cargo test --test integration_test -- --nocapture

  example-app-tests:
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests]
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build'))
    steps:
      - uses: actions/checkout@v4

      - name: Build and test example_app
        working-directory: example_app
        run: make docker-test

  build-wheel:
    runs-on: ${{ matrix.os }}
    needs: [python-lint, rust-lint]
    timeout-minutes: 30
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build'))
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact-name: rappel-wheel-Linux-x86_64
            build-sdist: true
          - os: ubuntu-24.04-arm
            artifact-name: rappel-wheel-Linux-aarch64
            build-sdist: false
          - os: macos-latest
            artifact-name: rappel-wheel-macOS
            build-sdist: false
          - os: windows-latest
            artifact-name: rappel-wheel-Windows
            build-sdist: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install protoc (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Install protoc (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: choco install protoc --version=25.1 -y

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          shared-key: rappel

      - name: Update project version
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build'))
        run: uv run scripts/update_version.py ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || '0.1.0' }}

      - name: Build wheel artifact
        run: uv run scripts/build_wheel.py --out-dir target/wheels

      - name: Build sdist artifact
        if: matrix.build-sdist
        run: uv build --project python --sdist --out-dir target/sdist

      - name: Upload sdist artifact
        if: matrix.build-sdist
        uses: actions/upload-artifact@v4
        with:
          name: rappel-sdist
          path: target/sdist/*.tar.gz

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: target/wheels/*.whl

  package-release:
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests, build-wheel]
    timeout-minutes: 20
    environment: pypi
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Download Linux x86_64 wheel
        uses: actions/download-artifact@v4
        with:
          name: rappel-wheel-Linux-x86_64
          path: artifacts/linux-x86_64

      - name: Download Linux aarch64 wheel
        uses: actions/download-artifact@v4
        with:
          name: rappel-wheel-Linux-aarch64
          path: artifacts/linux-aarch64

      - name: Download macOS wheel
        uses: actions/download-artifact@v4
        with:
          name: rappel-wheel-macOS
          path: artifacts/macos

      - name: Download Windows wheel
        uses: actions/download-artifact@v4
        with:
          name: rappel-wheel-Windows
          path: artifacts/windows

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: rappel-sdist
          path: artifacts/sdist

      - name: Assemble wheels
        run: |
          uv run scripts/assemble_wheels.py \
            --output target/release-wheels \
            --sdist artifacts/sdist \
            linux-x86_64=artifacts/linux-x86_64 \
            linux-aarch64=artifacts/linux-aarch64 \
            macos=artifacts/macos \
            windows=artifacts/windows

      - name: Upload consolidated wheels
        uses: actions/upload-artifact@v4
        with:
          name: rappel-wheels
          path: target/release-wheels

      - name: Publish wheels to PyPI
        if: startsWith(github.ref, 'refs/tags/v')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: target/release-wheels
