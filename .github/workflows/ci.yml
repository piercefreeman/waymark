name: CI

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:

jobs:
  python-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Python lint
        run: make python-lint-verify

  python-tests:
    runs-on: ubuntu-latest
    needs: python-lint
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Python tests with coverage
        run: make python-coverage

      - name: Upload Python coverage XML
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: python/coverage.xml

      - name: Upload Python coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage-html
          path: python/htmlcov

  rust-lint:
    runs-on: ubuntu-latest
    needs: python-lint
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Rust lint
        run: make rust-lint-verify

  rust-tests:
    runs-on: ubuntu-latest
    needs: [python-tests, rust-lint]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt, llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install nightly toolchain for branch coverage
        run: rustup toolchain install nightly --component llvm-tools-preview

      - name: Run tests with coverage
        run: make rust-coverage

      - name: Upload Rust coverage LCOV
        uses: actions/upload-artifact@v4
        with:
          name: rust-coverage
          path: target/rust-coverage.lcov

      - name: Upload Rust coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: rust-coverage-html
          path: target/rust-htmlcov

  main-coverage:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt, llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install nightly toolchain for branch coverage
        run: rustup toolchain install nightly --component llvm-tools-preview

      - name: Python tests with coverage
        run: make python-coverage

      - name: Rust tests with coverage
        run: make rust-coverage

      - name: Upload main Python coverage XML
        uses: actions/upload-artifact@v4
        with:
          name: main-python-coverage
          path: python/coverage.xml

      - name: Upload main Rust coverage LCOV
        uses: actions/upload-artifact@v4
        with:
          name: main-rust-coverage
          path: target/rust-coverage.lcov

  coverage-report:
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests, main-coverage]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Download Python coverage XML
        uses: actions/download-artifact@v4
        with:
          name: python-coverage
          path: coverage/pr/python

      - name: Download Rust coverage LCOV
        uses: actions/download-artifact@v4
        with:
          name: rust-coverage
          path: coverage/pr/rust

      - name: Download main Python coverage XML
        uses: actions/download-artifact@v4
        with:
          name: main-python-coverage
          path: coverage/main/python

      - name: Download main Rust coverage LCOV
        uses: actions/download-artifact@v4
        with:
          name: main-rust-coverage
          path: coverage/main/rust

      - name: Get artifact URLs
        id: artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            const pythonHtml = artifacts.data.artifacts.find(a => a.name === 'python-coverage-html');
            const rustHtml = artifacts.data.artifacts.find(a => a.name === 'rust-coverage-html');

            const baseUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts`;

            core.setOutput('python_html_url', pythonHtml ? `${baseUrl}/${pythonHtml.id}` : '');
            core.setOutput('rust_html_url', rustHtml ? `${baseUrl}/${rustHtml.id}` : '');

      - name: Generate coverage comment
        run: |
          uv run scripts/coverage_report.py \
            --python-xml coverage/pr/python/coverage.xml \
            --rust-lcov coverage/pr/rust/rust-coverage.lcov \
            --main-python-xml coverage/main/python/coverage.xml \
            --main-rust-lcov coverage/main/rust/rust-coverage.lcov \
            --python-html-url "${{ steps.artifacts.outputs.python_html_url }}" \
            --rust-html-url "${{ steps.artifacts.outputs.rust_html_url }}" \
            --format comment \
            --output coverage-comment.md

      - name: Post coverage comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage-report
          path: coverage-comment.md

  integration:
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests]
    timeout-minutes: 10
    if: github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build'))
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mountaineer
          POSTGRES_PASSWORD: mountaineer
          POSTGRES_DB: mountaineer_daemons
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc & clients
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler postgresql-client

      - name: Prepare Python worker environment
        working-directory: python
        run: uv sync

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Wait for Postgres
        run: pg_isready --host=localhost --port=5432 --username=mountaineer --dbname=mountaineer_daemons

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://mountaineer:mountaineer@localhost:5432/mountaineer_daemons
        run: cargo test workflow_executes_complex_flow -- --nocapture

  example-app-tests:
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests]
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build'))
    steps:
      - uses: actions/checkout@v4

      - name: Build and test example_app
        working-directory: example_app
        run: make docker-test

  build-wheel:
    runs-on: ${{ matrix.os }}
    needs: [python-tests, rust-tests]
    timeout-minutes: 20
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build'))
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install protoc (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install protoc (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Install protoc (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: choco install protoc --version=25.1 -y

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Update project version
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build'))
        run: uv run scripts/update_version.py ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || '0.1.0' }}

      - name: Build wheel artifact
        run: uv run scripts/build_wheel.py --out-dir target/wheels

      - name: Build sdist artifact (Linux only)
        if: runner.os == 'Linux'
        run: uv build --project python --sdist --out-dir target/sdist

      - name: Upload sdist artifact (Linux only)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: rappel-sdist
          path: target/sdist/*.tar.gz

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: rappel-wheel-${{ runner.os }}
          path: target/wheels/*.whl

  package-release:
    runs-on: ubuntu-latest
    needs: build-wheel
    timeout-minutes: 20
    environment: pypi
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'full-build'))
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Download Linux wheel
        uses: actions/download-artifact@v4
        with:
          name: rappel-wheel-Linux
          path: artifacts/linux

      - name: Download macOS wheel
        uses: actions/download-artifact@v4
        with:
          name: rappel-wheel-macOS
          path: artifacts/macos

      - name: Download Windows wheel
        uses: actions/download-artifact@v4
        with:
          name: rappel-wheel-Windows
          path: artifacts/windows

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: rappel-sdist
          path: artifacts/sdist

      - name: Assemble wheels
        run: |
          uv run scripts/assemble_wheels.py \
            --output target/release-wheels \
            --sdist artifacts/sdist \
            linux=artifacts/linux \
            macos=artifacts/macos \
            windows=artifacts/windows

      - name: Upload consolidated wheels
        uses: actions/upload-artifact@v4
        with:
          name: rappel-wheels
          path: target/release-wheels

      - name: Publish wheels to PyPI
        if: startsWith(github.ref, 'refs/tags/v')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: target/release-wheels
